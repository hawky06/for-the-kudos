<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>For the Kudos</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>

    <style>
        /* THEME VARIABLES */
        :root {
            --bg: #f5f5f5;
            --text: #1c1c1c;
            --card-bg: #ffffff;
            --accent: #fc4c02;
        }

        [data-theme="dark"] {
            --bg: #111111;
            --text: #f0f0f0;
            --card-bg: #1c1c1c;
            --accent: #fc4c02;
        }

        body {
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s ease, color 0.3s ease;
            padding-top: 50px;
        }

        .card {
            background: var(--card-bg) !important;
            color: var(--text) !important;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            padding-top: 50px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            margin: 20px auto;
            max-width: 500px;
            padding: 20px;
        }

        .stats .card,
        .leaderboard .card {
        max-width: 100%;
        }

        .leaderboard .card {
            background: var(--card-bg) !important;
            color: var(--text) !important;
        }

        /* White outline for leaderboard cards in dark mode */
        [data-theme="dark"] .leaderboard .card {
            border: 1px solid #fff !important;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-btn {
            display: block;
            margin: 50px auto;
        }

        #athleteAvatar {
            background: #fff;
            padding: 2px;
        }


       #map{
        background: var(--card-bg);
        height: 300px;
        border-radius: 12px;
        margin-top: 15px;
       }

       .site-footer {
        margin-top: 3rem;
        padding: 1rem;
        font-size: 0.85rem;
        text-align: center;
        color: #666;
        }

        .site-footer a {
        color: #fc4c02; /* Strava orange vibe */
        text-decoration: none;
        }
    </style>

</head>

<body>
    <header class="d-flex align-items-center justify-content-between px-3 py-2">
        <a href="/" class="d-flex align-items-center text-decoration-none">
            <img
                src="/static/for-the-kudos-logo.png"
                data-light="/static/for-the-kudos-logo-light.png"
                data-dark="/static/for-the-kudos-logo-dark.png"
                class="site-logo"
                alt="For the Kudos"
                style="height: 100px;"
            >
        </a>

        <div class="d-flex align-items-center gap-2">
            <button id="theme-toggle" class="btn btn-outline-secondary">
                üåô Dark Mode
            </button>

            <select id="unitToggle" class="form-select form-select-sm" style="width:120px">
                <option value="km">km</option>
                <option value="mi">miles</option>
            </select>
        </div>

    </header>

        {% if logged_in %}
            <div class="dashboard"> 
                <!-- LEFT: Stats -->
                <section class="stats">
                    <div class="card text-center shadow mb-4" id="athleteCard" style="display:none;">
                        <img id="athleteAvatar" class="rounded-circle mx-auto mt-3" width="96">
                        <h3 id="athleteName"></h3>
                        <p class="text-muted" id="athleteLocation"></p>
                    </div>
                    <p id="loading" class="text-center text-muted">
                        Loading your Strava stats‚Ä¶
                    </p>
                    <div id="stats" style="display:none;">
                        <div class="card text-center shadow">
                            <h2>Total Activities</h2>
                            <p class="display-5" id="totalActivities">-</p>
                        </div>

                        <div class="card text-center shadow">
                            <h2>Total Kudos</h2>
                            <p class="display-5" id="totalKudos">-</p>
                        </div>

                        <div class="card text-center shadow">
                            <h2>Average Kudos per Activity</h2>
                            <p class="display-5" id="avgKudos">-</p>
                        </div>

                        <div class="card text-centre shadow">
                            <h2>Kudos per Minute</h2>
                            <p class="display-5" id="kudos_per_min">-</p>
                        </div>

                        <div class="card text-center shadow">
                            <h2>Most Loved Activity</h2>
                            <p class="h4" id="activityName"></p>
                            <p class="text-muted" id="activityDate"></p>
                            <p id="activityKudos"></p>
                            <p id="activityDistance"></p>
                            <div id="map"></div>
                        </div>
                    </div>
                </section>

                <!-- RIGHT: Leaderboard -->
                <section class="leaderboard">
                    <div class="card shadow p-3">
                        <h3 class="mb-3">üèÜ Leaderboard</h3>

                        <select id="sort" class="form-select mb-3">
                            <option value="total_activities">Total Activities</option>
                            <option value="total_kudos">Total Kudos</option>
                            <option value="average_kudos">Average Kudos</option>
                            <option value="kudos_per_km">Kudos per km</option>
                            <option value="kudos_per_min">Kudos per min</option>
                        </select>

                        <div id="leaderboard"></div>
                    </div>
                </section>
            </div>  

            
            <script>
                // Athlete profile (fast) 
                fetch("/api/athlete")
                .then(r => r.json())
                .then(a => {
                    document.getElementById("athleteCard").style.display = "block";
                    document.getElementById("athleteAvatar").src = a.profile;
                    document.getElementById("athleteName").innerText = `${a.firstname} ${a.lastname}`;
                    document.getElementById("athleteLocation").innerText = `${a.city || ""} ${a.country || ""}`;
                });

                // Stats summary (fast)
                fetch("/api/stats/summary")
                .then(res => res.json())
                .then(summary => {
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("stats").style.display = "block";

                    document.getElementById("totalActivities").innerText = summary.total_activities;
                    document.getElementById("totalKudos").innerText = summary.total_kudos;
                    document.getElementById("avgKudos").innerText = summary.average_kudos;
                    document.getElementById("kudos_per_min").innerText = summary.average_kudos;

                    if (!summary.top_activity_id) return;

                    // load slow part after summary is shown
                    return fetch(`/api/stats/top-activity?id=${summary.top_activity_id}`);
                })

                .then(r => r && r.json())
                .then(activity => {
                    if (!activity) return;

                    document.getElementById("activityName").innerText = activity.name;
                    document.getElementById("activityDate").innerText = "üìÖ " + activity.date;
                    document.getElementById("activityKudos").innerText = "‚ù§Ô∏è " + activity.kudos + " kudos";
                    document.getElementById("activityDistance").innerText = "üìè " + formatDistanceKm(activity.distance_km);

                    if (activity.polyline) {
                        const coords = polyline.decode(activity.polyline);
                        const latlngs = coords.map(c => [c[0], c[1]]);

                        const map = L.map('map');
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                        const route = L.polyline(latlngs).addTo(map);
                        map.fitBounds(route.getBounds());
                    }
                })

                .catch(err => {
                    document.getElementById("loading").innerText = "Failed to load stats üò¢";
                    console.error(err);
                });
            </script>

            <script>
                // Leaderboard
                function loadLeaderboard() {
                    const unit = getUnit();

                    // Update label
                    const kudosLabel = document.querySelector(
                        'option[value="kudos_per_km"]'
                    );
                    kudosLabel.innerText =
                        unit === "mi" ? "Kudos per mile" : "Kudos per km";

                    const sort = document.getElementById("sort").value;

                    fetch(`/api/leaderboard?sort=${sort}`)
                        .then(r => r.json())
                        .then(data => {
                            document.getElementById("leaderboard").innerHTML =
                                data.map((a, index) => {
                                    let value = "-";
                                    let icon = "";

                                    if (sort === "total_activities") {
                                        value = a.total_activities;
                                        icon = "üèÉ";
                                    }
                                    else if (sort === "average_kudos") {
                                        value = a.average_kudos;
                                        icon = "üíñ";
                                    }
                                    else if (sort === "total_kudos") {
                                        value = a.total_kudos;
                                        icon = "‚ù§Ô∏è";
                                    }
                                    else if (sort === "kudos_per_km") {
                                        value =
                                            unit === "mi"
                                                ? (a.kudos_per_km * 0.621371).toFixed(2)
                                                : a.kudos_per_km.toFixed(2);
                                        icon = "üìè";
                                    }
                                    else if (sort === "kudos_per_min") {
                                        value = a.kudos_per_min;
                                        icon = "‚è±Ô∏è";
                                    }

                                    return `
                                        <div class="card p-2 mb-2 d-flex flex-row align-items-center">
                                            <span class="me-3 fw-bold">${index + 1}</span>
                                            <img src="${a.profile}" width="40" class="rounded-circle me-2"/>
                                            <strong>${a.name}</strong>
                                            <span class="ms-auto">${icon} ${value}</span>
                                        </div>
                                    `;
                                }).join("");
                        });
                }   

                document.getElementById("sort").addEventListener("change", loadLeaderboard);
                loadLeaderboard();

                // Show user's rank if not in top 20
                fetch("/api/leaderboard/rank")
                    .then(r => r.json())
                    .then(rank => {
                        if (!rank.rank) return;

                        if (rank.rank > 20) {
                            document.getElementById("leaderboard").innerHTML += `
                                <div class="card p-2 mt-3 d-flex flex-row align-items-center bg-warning-subtle">
                                    <span class="me-3 fw-bold">${rank.rank}</span>
                                    <strong>You</strong>
                                    <span class="ms-auto">‚¨áÔ∏è Your position</span>
                                </div>
                            `;
                        }
                    });
            </script>

        {% elif IS_PREVIEW %}
            <div class="preview-banner">
                Preview Environment - OAuth is disabled.
            </div>

        {% else %}
            <div class="text-center mt-5"></div>
                <a href="/login" class="btn btn-primary btn-lg login-btn">Login with Strava to see your stats</a>
            </div>
        {% endif %}
    </div>

    <script>
        // Theme toggle
        const toggle = document.getElementById("theme-toggle");

        // Update logo on page load based on theme
        function updateLogo(theme) {
            const logo = document.querySelector(".site-logo");
            logo.src = logo.dataset[theme];
        }   

        // Load saved theme from localStorage
        const saved = localStorage.getItem("theme");
        if (saved) {
            document.documentElement.setAttribute("data-theme", saved);
            toggle.textContent = saved === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
            updateLogo(saved);
        }

        const currentTheme = saved || "light";
        document.documentElement.setAttribute("data-theme", currentTheme);
        updateLogo(currentTheme);

        toggle.addEventListener("click", () => {
            const current = document.documentElement.getAttribute("data-theme");
            const next = current === "dark" ? "light" : "dark";

            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
            toggle.textContent = next === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
            updateLogo(next);
        });

        function getUnit() {
        return localStorage.getItem("unit") || "km";
        }

        function kmToMiles(km) {
            return km * 0.621371;
        }

        function formatDistanceKm(km) {
            return getUnit() === "mi"
                ? `${kmToMiles(km).toFixed(2)} mi`
                : `${km.toFixed(2)} km`;
        }


        const unitToggle = document.getElementById("unitToggle");

        // Set initial value
        unitToggle.value = getUnit();

        unitToggle.addEventListener("change", e => {
            localStorage.setItem("unit", e.target.value);
            loadLeaderboard();
            location.reload();
        });

    </script>

    <footer class="site-footer">
        <p>
            For the Kudos is an independent, open-source project using the Strava API.
            Not affiliated with Strava.
            <a href="https://github.com/hawky06/for-the-kudos" target="_blank">View source on GitHub</a>
        </p>
    </footer>

</body>

</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>For the Kudos</title>

    <button id="theme-toggle" class="btn btn-outline-secondary float-end">üåô Dark Mode</button>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>

    <style>
        /* THEME VARIABLES */
        :root {
            --bg: #111;
            --text: #fff;
            --card-bg: #1c1c1c;
        }

        [data-theme="dark"] {
            --bg: #111111;
            --text: #f0f0f0;
            --card-bg: #1c1c1c;
            --accent: #fc4c02;
        }

        body {
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s ease, color 0.3s ease;
            padding-top: 50px;
        }

        .card {
            background: var(--card-bg);
            color: var(--text);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            padding-top: 50px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            margin: 20px auto;
            max-width: 500px;
            padding: 20px;
        }

        .stats .card,
        .leaderboard .card {
        max-width: 100%;
        }

        .leaderboard .card {
            background: var(--card-bg);
            color: var(--text);
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-btn {
            display: block;
            margin: 50px auto;
        }

       #map{
        background: var(--card-bg);
        height: 300px;
        border-radius: 12px;
        margin-top: 15px;
       }

       .site-footer {
        margin-top: 3rem;
        padding: 1rem;
        font-size: 0.85rem;
        text-align: center;
        color: #666;
        }

        .site-footer a {
        color: #fc4c02; /* Strava orange vibe */
        text-decoration: none;
        }
    </style>


</head>
<body>
    <div class="container">
        <h1>üèÉ‚Äç‚ôÇÔ∏è For the Kudos üèÉ‚Äç‚ôÄÔ∏è</h1>

        {% if logged_in %}
            <div class="dashboard"> 
                <!-- LEFT: Stats -->
                <section class="stats">
                    <div class="card text-center shadow mb-4" id="athleteCard" style="display:none;">
                        <img id="athleteAvatar" class="rounded-circle mx-auto mt-3" width="96">
                        <h3 id="athleteName"></h3>
                        <p class="text-muted" id="athleteLocation"></p>
                    </div>
                    <p id="loading" class="text-center text-muted">
                        Loading your Strava stats‚Ä¶
                    </p>
                    <div id="stats" style="display:none;">
                        <div class="card text-center shadow">
                            <h2>Total Activities</h2>
                            <p class="display-5" id="totalActivities">-</p>
                        </div>

                        <div class="card text-center shadow">
                            <h2>Total Kudos</h2>
                            <p class="display-5" id="totalKudos">-</p>
                        </div>

                        <div class="card text-center shadow">
                            <h2>Average Kudos per Activity</h2>
                            <p class="display-5" id="avgKudos">-</p>
                        </div>

                        <div class="card text-center shadow">
                            <h2>Most Loved Activity</h2>
                            <p class="h4" id="activityName"></p>
                            <p class="text-muted" id="activityDate"></p>
                            <p id="activityKudos"></p>
                            <p id="activityDistance"></p>
                            <div id="map"></div>
                        </div>
                    </div>
                </section>

                <!-- RIGHT: Leaderboard -->
                <section class="leaderboard">
                    <div class="card shadow p-3">
                        <h3 class="mb-3">üèÜ Leaderboard</h3>

                        <select id="sort" class="form-select mb-3">
                            <option value="total_kudos">Total Kudos</option>
                            <option value="average_kudos">Average Kudos</option>
                            <option value="total_activities">Total Activities</option>
                        </select>

                        <div id="leaderboard"></div>
                    </div>
                </section>
            </div>  

            
            <script>
            // Athlete profile (fast) 
            fetch("/api/athlete")
            .then(r => r.json())
            .then(a => {
                document.getElementById("athleteCard").style.display = "block";
                document.getElementById("athleteAvatar").src = a.profile;
                document.getElementById("athleteName").innerText = `${a.firstname} ${a.lastname}`;
                document.getElementById("athleteLocation").innerText = `${a.city || ""} ${a.country || ""}`;
            });

            // Stats summary (fast)
            fetch("/api/stats/summary")
            .then(res => res.json())
            .then(summary => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("stats").style.display = "block";

                document.getElementById("totalActivities").innerText = summary.total_activities;
                document.getElementById("totalKudos").innerText = summary.total_kudos;
                document.getElementById("avgKudos").innerText = summary.average_kudos;

                if (!summary.top_activity_id) return;

                // load slow part after summary is shown
                return fetch(`/api/stats/top-activity?id=${summary.top_activity_id}`);
            })

            .then(r => r && r.json())
            .then(activity => {
                if (!activity) return;

                document.getElementById("activityName").innerText = activity.name;
                document.getElementById("activityDate").innerText = "üìÖ " + activity.date;
                document.getElementById("activityKudos").innerText = "‚ù§Ô∏è " + activity.kudos + " kudos";
                document.getElementById("activityDistance").innerText = "üìè " + activity.distance_km + " km";

                if (activity.polyline) {
                    const coords = polyline.decode(activity.polyline);
                    const latlngs = coords.map(c => [c[0], c[1]]);

                    const map = L.map('map');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    const route = L.polyline(latlngs).addTo(map);
                    map.fitBounds(route.getBounds());
                }
            })

            .catch(err => {
                document.getElementById("loading").innerText = "Failed to load stats üò¢";
                console.error(err);
            });
            </script>

            <script>
            // Leaderboard
            function loadLeaderboard() {
                const sort = document.getElementById("sort").value;

                fetch(`/api/leaderboard?sort=${sort}`)
                    .then(r => r.json())
                    .then(data => {
                    document.getElementById("leaderboard").innerHTML =
                        data.map(a => {
                        let value;
                        let icon;

                        if (sort === "average_kudos") {
                            value = a.average_kudos;
                            icon = "üíñ";
                        } else if (sort === "total_activities") {
                            value = a.total_activities;
                            icon = "üèÉ";
                        } else {
                            value = a.total_kudos;
                            icon = "‚ù§Ô∏è";
                        }

                        return `
                            <div class="card p-2 mb-2 d-flex flex-row align-items-center">
                            <img src="${a.profile}" width="40" class="rounded-circle me-2"/>
                            <strong>${a.name}</strong>
                            <span class="ms-auto">${icon} ${value}</span>
                            </div>
                        `;
                        }).join("");
                    });
            }

            document.getElementById("sort").addEventListener("change", loadLeaderboard);
            loadLeaderboard();
            </script>

        {% elif IS_PREVIEW %}
            <div class="preview-banner">
                Preview Environment - OAuth is disabled.
            </div>

        {% else %}
            <div class="text-center mt-5"></div>
                <a href="/login" class="btn btn-primary btn-lg login-btn">Login with Strava to see your stats</a>
            </div>
        {% endif %}
    </div>

    <script>
        const toggle = document.getElementById("theme-toggle");

        const saved = localStorage.getItem("theme");
        if (saved) {
            document.documentElement.setAttribute("data-theme", saved);
            toggle.textContent = saved === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
        }

        toggle.addEventListener("click", () => {
            const current = document.documentElement.getAttribute("data-theme");
            const next = current === "dark" ? "light" : "dark";

            document.documentElement.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);

            toggle.textContent = next === "dark" ? "‚òÄÔ∏è Light Mode" : "üåô Dark Mode";
        });
    </script>

    <footer class="site-footer">
        <p>
            For the Kudos is an independent, open-source project using the Strava API.
            Not affiliated with Strava.
            <a href="https://github.com/hawky06/for-the-kudos" target="_blank">View source on GitHub</a>
        </p>
    </footer>

</body>

</html>

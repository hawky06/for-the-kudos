<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>For the Kudos</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 50px;
        }
        .card {
            margin: 20px auto;
            max-width: 500px;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 40px;
        }
        .login-btn {
            display: block;
            margin: 50px auto;
        }
       #map{
        height: 300px;
        border-radius: 12px;
        margin-top: 15px;
       }
    </style>


</head>
<body>
    <div class="container">
        <h1>üèÉ‚Äç‚ôÇÔ∏è For the Kudos üèÉ‚Äç‚ôÄÔ∏è</h1>

        {% if logged_in %}
            <p id="loading" class="text-center text-muted">
                Loading your Strava stats‚Ä¶
            </p>
            <div class="card text-center shadow mb-4" id="athleteCard" style="display:none;">
                <img id="athleteAvatar" class="rounded-circle mx-auto mt-3" width="96">
                <h3 id="athleteName"></h3>
                <p class="text-muted" id="athleteLocation"></p>
            </div>
            <div id="stats" style="display:none;">
                <div class="card text-center shadow">
                    <h2>Total Activities</h2>
                    <p class="display-5" id="totalActivities">-</p>
                </div>

                <div class="card text-center shadow">
                    <h2>Total Kudos</h2>
                    <p class="display-5" id="totalKudos">-</p>
                </div>

                <div class="card text-center shadow">
                    <h2>Average Kudos per Activity</h2>
                    <p class="display-5" id="avgKudos">-</p>
                </div>

                <div class="card text-center shadow">
                    <h2>Most Loved Activity</h2>
                    <p class="h4" id="activityName"></p>
                    <p class="text-muted" id="activityDate"></p>
                    <p id="activityKudos"></p>
                    <p id="activityDistance"></p>
                    <div id="map"></div>
                </div>
            </div>

            
            <script>
            // Athlete profile (fast) 
            fetch("/api/athlete")
            .then(r => r.json())
            .then(a => {
                document.getElementById("athleteCard").style.display = "block";
                document.getElementById("athleteAvatar").src = a.profile;
                document.getElementById("athleteName").innerText = `${a.firstname} ${a.lastname}`;
                document.getElementById("athleteLocation").innerText = `${a.city || ""} ${a.country || ""}`;
            });

            // Stats summary (fast)
            fetch("/api/stats/summary")
            .then(res => res.json())
            .then(summary => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("stats").style.display = "block";

                document.getElementById("totalActivities").innerText = summary.total_activities;
                document.getElementById("totalKudos").innerText = summary.total_kudos;
                document.getElementById("avgKudos").innerText = summary.average_kudos;

                if (!summary.top_activity_id) return;

                // load slow part after summary is shown
                return fetch(`/api/stats/top-activity?id=${summary.top_activity_id}`);
            })

            .then(r => r ? r.json() : null)
            .then(activity => {
                if (!activity) return;

                document.getElementById("activityName").innerText = activity.name;
                document.getElementById("activityDate").innerText = "üìÖ " + activity.date;
                document.getElementById("activityKudos").innerText = "‚ù§Ô∏è " + activity.kudos + " kudos";
                document.getElementById("activityDistance").innerText = "üìè " + activity.distance_km + " km";

                if (activity.polyline) {
                    const coords = polyline.decode(activity.polyline);
                    const latlngs = coords.map(c => [c[0], c[1]]);

                    const map = L.map('map');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    const route = L.polyline(latlngs).addTo(map);
                    map.fitBounds(route.getBounds());
                }
            })
            
            .catch(err => {
                document.getElementById("loading").innerText = "Failed to load stats üò¢";
                console.error(err);
            });
            </script>
            
        {% else %}
            <div class="text-center mt-5"></div>
                <a href="/login" class="btn btn-primary btn-lg login-btn">Login with Strava to see your stats</a>
            </div>
        {% endif %}
    </div>
</body>
</html>
